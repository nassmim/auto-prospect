module.exports=[5522,(a,b,c)=>{"use strict";Object.defineProperty(c,"__esModule",{value:!0}),Object.defineProperty(c,"registerServerReference",{enumerable:!0,get:function(){return d.registerServerReference}});let d=a.r(82260)},51187,(a,b,c)=>{b.exports=a.x("next/dist/server/lib/incremental-cache/tags-manifest.external.js",()=>require("next/dist/server/lib/incremental-cache/tags-manifest.external.js"))},52616,a=>{"use strict";a.s(["CACHE_TAGS",0,{huntsByAccount:a=>`hunts:${a}`,hunt:a=>`hunt:${a}`,templatesByAccount:a=>`templates:${a}`,teamMembersByAccount:a=>`team-members:${a}`,account:a=>`account:${a}`}])},63224,a=>{"use strict";var b=a.i(81446);a.i(96875);var c=a.i(42810);async function d(){let a=await (0,b.createDrizzleSupabaseClient)(),[d,e,f]=await Promise.all([a.rls(a=>a.query.creditBalances.findFirst()),a.rls(a=>a.query.huntChannelCredits.findMany({with:{hunt:{columns:{id:!0,name:!0}}}})),a.rls(a=>a.query.creditTransactions.findMany({orderBy:a=>[(0,c.desc)(a.createdAt)],limit:50}))]);return{balance:d,huntAllocations:e.map(a=>({huntId:a.huntId,huntName:a.hunt.name,channel:a.channel,allocated:a.creditsAllocated,consumed:a.creditsConsumed,remaining:a.creditsAllocated-a.creditsConsumed})),transactions:f.map(a=>({id:a.id,type:a.type,channel:a.channel,amount:a.amount,balanceAfter:a.balanceAfter,createdAt:a.createdAt,metadata:a.metadata}))}}a.s(["getAccountCredits",()=>d])},34270,(a,b,c)=>{b.exports=a.x("next/dist/server/app-render/module-loading/track-module-loading.external.js",()=>require("next/dist/server/app-render/module-loading/track-module-loading.external.js"))},61980,(a,b,c)=>{"use strict";Object.defineProperty(c,"__esModule",{value:!0}),Object.defineProperty(c,"trackDynamicImport",{enumerable:!0,get:function(){return g}});let d=a.r(48638),e=a.r(94837),f=a.r(34270);function g(a){if(!(0,e.isThenable)(a))throw Object.defineProperty(new d.InvariantError("`trackDynamicImport` should always receive a promise. Something went wrong in the dynamic imports transform."),"__NEXT_ERROR_CODE",{value:"E677",enumerable:!1,configurable:!0});return(0,f.trackPendingImport)(a),a}},72705,(a,b,c)=>{"use strict";Object.defineProperty(c,"__esModule",{value:!0}),Object.defineProperty(c,"trackDynamicImport",{enumerable:!0,get:function(){return d.trackDynamicImport}});let d=a.r(61980)},6347,a=>{"use strict";var b=a.i(72705),c=a.i(5522),d=a.i(20840),e=a.i(26442),f=a.i(67304),g=a.i(52616),h=a.i(81446),i=a.i(6495),j=a.i(63224);a.i(96875);var k=a.i(77554),l=a.i(42810),m=a.i(4867),n=a.i(69070),o=a.i(73240),p=a.i(675);async function q(a){let b=await (0,h.createDrizzleSupabaseClient)();try{let c=await b.rls(async b=>b.query.leads.findFirst({where:(b,{eq:c})=>c(b.id,a),columns:{accountId:!0}}));if(!c)throw Error("Lead not found");return await b.rls(async a=>a.query.messageTemplates.findFirst({where:(a,{eq:b,and:d})=>d(b(a.accountId,c.accountId),b(a.channel,o.EContactChannel.WHATSAPP_TEXT),b(a.isDefault,!0))}))}catch{throw Error("Failed to fetch WhatsApp template")}}async function r(a,b,c){let d=await (0,h.createDrizzleSupabaseClient)();try{let e=await d.rls(async b=>await b.query.leads.findFirst({where:(b,{eq:c})=>c(b.id,a),columns:{huntId:!0,assignedToId:!0,accountId:!0}}));if(!e)throw Error("Lead not found");let g=await (0,j.consumeCredit)({huntId:e.huntId,channel:o.EContactChannel.WHATSAPP_TEXT});if(!g.success)throw Error(g.error);let h=await d.rls(async d=>{let[f]=await d.insert(n.messages).values({leadId:a,templateId:c||null,channel:o.EContactChannel.WHATSAPP_TEXT,content:b,status:"sent",sentAt:new Date,sentById:e.assignedToId||e.accountId}).returning();return await d.insert(m.leadNotes).values({leadId:a,content:`Message WhatsApp envoy\xe9`}),f});return h?.id&&g.transaction?.id&&await d.admin.update(k.creditTransactions).set({referenceId:h.id,metadata:{messageId:h.id}}).where((0,l.eq)(k.creditTransactions.id,g.transaction.id)),(0,p.revalidatePath)(f.pages.leads.detail(a)),{success:!0}}catch(a){throw Error(a instanceof Error?a.message:"Failed to log WhatsApp message")}}async function s(){let a=await (0,h.createDrizzleSupabaseClient)();return v((await (0,i.getUserAccount)(a,{columnsToKeep:{id:!0}})).id,a)}let t=async function(c,d){let{cacheTag:e}=await (0,b.trackDynamicImport)(a.A(81381)),{CACHE_TAGS:f}=await (0,b.trackDynamicImport)(a.A(44426));e(f.templatesByAccount(c));let g=d||await (0,h.createDrizzleSupabaseClient)();try{return await g.rls(async a=>a.query.messageTemplates.findMany({where:(a,{eq:b})=>b(a.accountId,c),with:{account:{columns:{id:!0,name:!0}}},orderBy:(a,{desc:b})=>[b(a.createdAt)]}))}catch(a){throw console.error("Error fetching templates:",a),Error("Failed to fetch templates")}};var u=(0,e.cache)(function(){return(0,d.cache)("default","e0d884f19ec9288fa94a30ca8841972647d88a166f",0,t,arguments)});(0,c.registerServerReference)(u,"e0d884f19ec9288fa94a30ca8841972647d88a166f",null),Object.defineProperty(u,"name",{value:"getCachedAccountTemplates"});var v=u;async function w(){try{return!!(await (0,i.getUserAccount)(void 0,{columnsToKeep:{id:!0,smsApiKey:!0}})).smsApiKey}catch{return!1}}async function x(){try{return!!(await (0,i.getUserAccount)(void 0,{columnsToKeep:{id:!0,smsMobileAPiAllowed:!0}})).smsMobileAPiAllowed}catch{return!1}}let y=async(a,b)=>{let c=b;c||(c=(await (0,i.getUserAccount)(a,{columnsToKeep:{id:!0}})).id),(0,p.updateTag)(g.CACHE_TAGS.templatesByAccount(c))};a.s(["$$RSC_SERVER_CACHE_0",()=>u,"getAccountTemplates",()=>s,"getDefaultWhatsAppTemplate",()=>q,"hasSmsApiKeyAction",()=>w,"isSmsApiAllowedAction",()=>x,"logWhatsAppMessage",()=>r,"updateAccountTemplatesCache",0,y])},14392,(a,b,c)=>{"use strict";function d(a){for(let b=0;b<a.length;b++){let c=a[b];if("function"!=typeof c)throw Object.defineProperty(Error(`A "use server" file can only export async functions, found ${typeof c}.
Read more: https://nextjs.org/docs/messages/invalid-use-server-value`),"__NEXT_ERROR_CODE",{value:"E352",enumerable:!1,configurable:!0})}}Object.defineProperty(c,"__esModule",{value:!0}),Object.defineProperty(c,"ensureServerEntryExports",{enumerable:!0,get:function(){return d}})},23030,5707,44594,21754,33258,31460,a=>{"use strict";function b(a){return Object.values(a.flatten().fieldErrors).flat()[0]??"Données de formulaire invalides"}a.s(["formatZodError",()=>b],23030);var c=a.i(37411),c=c;let d=c.object({leboncoin:c.boolean().optional(),whatsapp:c.boolean().optional(),sms:c.boolean().optional(),ringlessVoice:c.boolean().optional()}).optional(),e=c.object({leboncoin:c.string().nullable().optional(),whatsapp:c.string().nullable().optional(),sms:c.string().nullable().optional(),ringlessVoice:c.string().nullable().optional()}).optional(),f=c.object({sms:c.number().int().min(0,"Les crédits doivent être positifs").optional(),whatsapp:c.number().int().min(0,"Les crédits doivent être positifs").optional(),ringlessVoice:c.number().int().min(0,"Les crédits doivent être positifs").optional()}).optional(),g=c.object({name:c.string().min(1,"Le nom est requis").max(100,"Le nom ne peut pas dépasser 100 caractères"),searchUrl:c.string().url("Veuillez entrer une URL valide").refine(a=>a.includes("leboncoin.fr"),"L'URL doit provenir de Leboncoin").optional(),autoRefresh:c.boolean(),dailyPacingLimit:c.number().int().min(1).max(1e3).optional().nullable(),outreachSettings:d,templateIds:e,channelCredits:f}).refine(a=>{let b=a.outreachSettings;return!!b&&(b.whatsapp||b.sms||b.ringlessVoice)},{message:"Au moins un canal de communication doit être activé",path:["outreachSettings"]}).refine(a=>{let b=a.outreachSettings,c=a.channelCredits;return!b||!c||(!b.sms||!!c.sms&&!(c.sms<=0))&&(!b.ringlessVoice||!!c.ringlessVoice&&!(c.ringlessVoice<=0))},{message:"Les canaux activés doivent avoir des crédits alloués (> 0)",path:["channelCredits"]}).safeExtend({locationId:c.number().positive("L'emplacement est requis"),radiusInKm:c.number().min(0).default(0),adTypeId:c.number().positive("Le type d'annonce est requis"),dailyPacingLimit:c.number().int().min(1).max(1e3).optional().nullable(),priceMin:c.number().min(0).optional(),priceMax:c.number().positive().optional(),mileageMin:c.number().min(0).optional(),mileageMax:c.number().positive().optional(),modelYearMin:c.number().int().min(1900).optional(),modelYearMax:c.number().int().max(new Date().getFullYear()+1).optional(),hasBeenReposted:c.boolean().optional(),priceHasDropped:c.boolean().optional(),isUrgent:c.boolean().optional(),hasBeenBoosted:c.boolean().optional(),isLowPrice:c.boolean().optional(),brandIds:c.array(c.number()).optional(),subTypeIds:c.array(c.number()).optional()}).refine(a=>{let b=a.outreachSettings;return!!b&&(b.whatsapp||b.sms||b.ringlessVoice)},{message:"Au moins un canal de communication doit être activé",path:["outreachSettings"]}).refine(a=>{let b=a.outreachSettings,c=a.channelCredits;return!b||!c||(!b.sms||!!c.sms&&!(c.sms<=0))&&(!b.ringlessVoice||!!c.ringlessVoice&&!(c.ringlessVoice<=0))},{message:"Les canaux activés doivent avoir des crédits alloués (> 0)",path:["channelCredits"]}),h=c.object({name:c.string().min(1,"Le nom est requis").max(100,"Le nom ne peut pas dépasser 100 caractères").optional(),autoRefresh:c.boolean().optional(),dailyPacingLimit:c.number().int().min(1).max(1e3).optional().nullable(),outreachSettings:d,templateIds:e,locationId:c.number().positive().optional(),radiusInKm:c.number().min(0).optional(),priceMin:c.number().min(0).optional(),priceMax:c.number().positive().optional(),mileageMin:c.number().min(0).optional(),mileageMax:c.number().positive().optional(),modelYearMin:c.number().int().min(1900).optional(),modelYearMax:c.number().int().max(new Date().getFullYear()+1).optional(),hasBeenReposted:c.boolean().optional(),priceHasDropped:c.boolean().optional(),isUrgent:c.boolean().optional(),hasBeenBoosted:c.boolean().optional(),isLowPrice:c.boolean().optional()});a.s(["createHuntSchema",0,g,"updateHuntSchema",0,h],5707);var i=a.i(73240),c=c;let j=c.object({name:c.string().min(1,"Le nom est requis").max(100,"Le nom ne peut pas dépasser 100 caractères"),channel:c.enum(Object.values(i.EContactChannel),{message:"Canal invalide"}),content:c.string().min(1,"Le contenu du message est requis").max(2e3,"Le contenu ne peut pas dépasser 2000 caractères"),isDefault:c.boolean()}),k=c.object({name:c.string().min(1,"Le nom est requis").max(100,"Le nom ne peut pas dépasser 100 caractères"),channel:c.enum(Object.values(i.EContactChannel),{message:"Canal invalide"}),audioUrl:c.string().url("URL audio invalide"),audioDuration:c.number().min(15,"La durée minimale est de 15 secondes").max(55,"La durée maximale est de 55 secondes"),isDefault:c.boolean()});c.object({name:c.string().min(1,"Le nom est requis").max(100,"Le nom ne peut pas dépasser 100 caractères"),audioBlob:c.instanceof(Blob,{message:"Veuillez enregistrer ou importer un fichier audio"}),audioDuration:c.number().min(15,"La durée minimale est de 15 secondes").max(55,"La durée maximale est de 55 secondes"),isDefault:c.boolean()}),a.s(["textTemplateSchema",0,j,"voiceTemplateSchema",0,k],44594);var c=c;let l=c.object({content:c.string().min(1,"Le contenu de la note est requis").max(5e3,"La note ne peut pas dépasser 5000 caractères")}),m=c.object({dueAt:c.coerce.date().refine(a=>a>new Date,"La date doit être dans le futur"),note:c.string().max(1e3,"La note ne peut pas dépasser 1000 caractères").optional()});c.object({dueAt:c.date().refine(a=>a>new Date,"La date doit être dans le futur"),note:c.string().max(1e3,"La note ne peut pas dépasser 1000 caractères").optional()}),a.s(["leadNoteSchema",0,l,"leadReminderSchema",0,m],21754);var c=c;c.object({email:c.string().email("Adresse email invalide").min(1,"L'email est requis"),role:c.enum(["admin","user"],{message:"Le rôle est requis"})}),c.object({name:c.string().min(1,"Le nom de l'organisation est requis").max(100,"Le nom ne peut pas dépasser 100 caractères")});let n=c.object({apiKey:c.string().min(1,"Ta clé api est requise")}),o=c.object({to:c.string().min(1,"Le numéro du destinataire est requis"),message:c.string().min(1,"Le message est requis.")});a.s(["saveSmsApiKeySchema",0,n,"sendSmsSchema",0,o],33258),a.i(27210),a.s([],31460)}];

//# sourceMappingURL=%5Broot-of-the-server%5D__371430c4._.js.map