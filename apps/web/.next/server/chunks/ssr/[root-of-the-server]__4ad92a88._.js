module.exports=[6347,a=>{"use strict";var b=a.i(72705),c=a.i(5522),d=a.i(20840),e=a.i(26442),f=a.i(67304),g=a.i(52616),h=a.i(81446),i=a.i(6495),j=a.i(63224);a.i(96875);var k=a.i(77554),l=a.i(42810),m=a.i(4867),n=a.i(69070),o=a.i(73240),p=a.i(675);async function q(a){let b=await (0,h.createDrizzleSupabaseClient)();try{let c=await b.rls(async b=>b.query.leads.findFirst({where:(b,{eq:c})=>c(b.id,a),columns:{accountId:!0}}));if(!c)throw Error("Lead not found");return await b.rls(async a=>a.query.messageTemplates.findFirst({where:(a,{eq:b,and:d})=>d(b(a.accountId,c.accountId),b(a.channel,o.EContactChannel.WHATSAPP_TEXT),b(a.isDefault,!0))}))}catch{throw Error("Failed to fetch WhatsApp template")}}async function r(a,b,c){let d=await (0,h.createDrizzleSupabaseClient)();try{let e=await d.rls(async b=>await b.query.leads.findFirst({where:(b,{eq:c})=>c(b.id,a),columns:{huntId:!0,assignedToId:!0,accountId:!0}}));if(!e)throw Error("Lead not found");let g=await (0,j.consumeCredit)({huntId:e.huntId,channel:o.EContactChannel.WHATSAPP_TEXT});if(!g.success)throw Error(g.error);let h=await d.rls(async d=>{let[f]=await d.insert(n.messages).values({leadId:a,templateId:c||null,channel:o.EContactChannel.WHATSAPP_TEXT,content:b,status:"sent",sentAt:new Date,sentById:e.assignedToId||e.accountId}).returning();return await d.insert(m.leadNotes).values({leadId:a,content:`Message WhatsApp envoy\xe9`}),f});return h?.id&&g.transaction?.id&&await d.admin.update(k.creditTransactions).set({referenceId:h.id,metadata:{messageId:h.id}}).where((0,l.eq)(k.creditTransactions.id,g.transaction.id)),(0,p.revalidatePath)(f.pages.leads.detail(a)),{success:!0}}catch(a){throw Error(a instanceof Error?a.message:"Failed to log WhatsApp message")}}async function s(){let a=await (0,h.createDrizzleSupabaseClient)();return v((await (0,i.getUserAccount)(a,{columnsToKeep:{id:!0}})).id,a)}let t=async function(c,d){let{cacheTag:e}=await (0,b.trackDynamicImport)(a.A(81381)),{CACHE_TAGS:f}=await (0,b.trackDynamicImport)(a.A(44426));e(f.templatesByAccount(c));let g=d||await (0,h.createDrizzleSupabaseClient)();try{return await g.rls(async a=>a.query.messageTemplates.findMany({where:(a,{eq:b})=>b(a.accountId,c),with:{account:{columns:{id:!0,name:!0}}},orderBy:(a,{desc:b})=>[b(a.createdAt)]}))}catch(a){throw console.error("Error fetching templates:",a),Error("Failed to fetch templates")}};var u=(0,e.cache)(function(){return(0,d.cache)("default","e0d884f19ec9288fa94a30ca8841972647d88a166f",0,t,arguments)});(0,c.registerServerReference)(u,"e0d884f19ec9288fa94a30ca8841972647d88a166f",null),Object.defineProperty(u,"name",{value:"getCachedAccountTemplates"});var v=u;async function w(){try{return!!(await (0,i.getUserAccount)(void 0,{columnsToKeep:{id:!0,smsApiKey:!0}})).smsApiKey}catch{return!1}}async function x(){try{return!!(await (0,i.getUserAccount)(void 0,{columnsToKeep:{id:!0,smsMobileAPiAllowed:!0}})).smsMobileAPiAllowed}catch{return!1}}let y=async(a,b)=>{let c=b;c||(c=(await (0,i.getUserAccount)(a,{columnsToKeep:{id:!0}})).id),(0,p.updateTag)(g.CACHE_TAGS.templatesByAccount(c))};a.s(["$$RSC_SERVER_CACHE_0",()=>u,"getAccountTemplates",()=>s,"getDefaultWhatsAppTemplate",()=>q,"hasSmsApiKeyAction",()=>w,"isSmsApiAllowedAction",()=>x,"logWhatsAppMessage",()=>r,"updateAccountTemplatesCache",0,y])},52616,a=>{"use strict";a.s(["CACHE_TAGS",0,{huntsByAccount:a=>`hunts:${a}`,hunt:a=>`hunt:${a}`,templatesByAccount:a=>`templates:${a}`,teamMembersByAccount:a=>`team-members:${a}`,account:a=>`account:${a}`}])},40972,(a,b,c)=>{"use strict";Object.defineProperty(c,"__esModule",{value:!0});var d={RequestCookies:function(){return f.RequestCookies},ResponseCookies:function(){return f.ResponseCookies},stringifyCookie:function(){return f.stringifyCookie}};for(var e in d)Object.defineProperty(c,e,{enumerable:!0,get:d[e]});let f=a.r(70250)},83737,(a,b,c)=>{"use strict";Object.defineProperty(c,"__esModule",{value:!0});var d={ActionDidNotRevalidate:function(){return f},ActionDidRevalidateDynamicOnly:function(){return h},ActionDidRevalidateStaticAndDynamic:function(){return g}};for(var e in d)Object.defineProperty(c,e,{enumerable:!0,get:d[e]});let f=0,g=1,h=2},77630,(a,b,c)=>{"use strict";function d(){let a,b,c=new Promise((c,d)=>{a=c,b=d});return{resolve:a,reject:b,promise:c}}Object.defineProperty(c,"__esModule",{value:!0}),Object.defineProperty(c,"createPromiseWithResolvers",{enumerable:!0,get:function(){return d}})},90295,(a,b,c)=>{"use strict";Object.defineProperty(c,"__esModule",{value:!0});var d,e={RenderStage:function(){return i},StagedRenderingController:function(){return j}};for(var f in e)Object.defineProperty(c,f,{enumerable:!0,get:e[f]});let g=a.r(48638),h=a.r(77630);var i=((d={})[d.Before=1]="Before",d[d.Static=2]="Static",d[d.Runtime=3]="Runtime",d[d.Dynamic=4]="Dynamic",d[d.Abandoned=5]="Abandoned",d);class j{constructor(a=null,b){this.abortSignal=a,this.hasRuntimePrefetch=b,this.currentStage=1,this.staticInterruptReason=null,this.runtimeInterruptReason=null,this.staticStageEndTime=1/0,this.runtimeStageEndTime=1/0,this.runtimeStageListeners=[],this.dynamicStageListeners=[],this.runtimeStagePromise=(0,h.createPromiseWithResolvers)(),this.dynamicStagePromise=(0,h.createPromiseWithResolvers)(),this.mayAbandon=!1,a&&(a.addEventListener("abort",()=>{let{reason:b}=a;this.currentStage<3&&(this.runtimeStagePromise.promise.catch(k),this.runtimeStagePromise.reject(b)),(this.currentStage<4||5===this.currentStage)&&(this.dynamicStagePromise.promise.catch(k),this.dynamicStagePromise.reject(b))},{once:!0}),this.mayAbandon=!0)}onStage(a,b){if(this.currentStage>=a)b();else if(3===a)this.runtimeStageListeners.push(b);else if(4===a)this.dynamicStageListeners.push(b);else throw Object.defineProperty(new g.InvariantError(`Invalid render stage: ${a}`),"__NEXT_ERROR_CODE",{value:"E881",enumerable:!1,configurable:!0})}canSyncInterrupt(){if(1===this.currentStage)return!1;let a=this.hasRuntimePrefetch?4:3;return this.currentStage<a}syncInterruptCurrentStageWithReason(a){if(1!==this.currentStage){if(this.mayAbandon)return this.abandonRenderImpl();switch(this.currentStage){case 2:this.staticInterruptReason=a,this.advanceStage(4);return;case 3:this.hasRuntimePrefetch&&(this.runtimeInterruptReason=a,this.advanceStage(4));return}}}getStaticInterruptReason(){return this.staticInterruptReason}getRuntimeInterruptReason(){return this.runtimeInterruptReason}getStaticStageEndTime(){return this.staticStageEndTime}getRuntimeStageEndTime(){return this.runtimeStageEndTime}abandonRender(){if(!this.mayAbandon)throw Object.defineProperty(new g.InvariantError("`abandonRender` called on a stage controller that cannot be abandoned."),"__NEXT_ERROR_CODE",{value:"E938",enumerable:!1,configurable:!0});this.abandonRenderImpl()}abandonRenderImpl(){let{currentStage:a}=this;switch(a){case 2:this.currentStage=5,this.resolveRuntimeStage();return;case 3:this.currentStage=5;return}}advanceStage(a){if(a<=this.currentStage)return;let b=this.currentStage;if(this.currentStage=a,b<3&&a>=3&&(this.staticStageEndTime=performance.now()+performance.timeOrigin,this.resolveRuntimeStage()),b<4&&a>=4){this.runtimeStageEndTime=performance.now()+performance.timeOrigin,this.resolveDynamicStage();return}}resolveRuntimeStage(){let a=this.runtimeStageListeners;for(let b=0;b<a.length;b++)a[b]();a.length=0,this.runtimeStagePromise.resolve()}resolveDynamicStage(){let a=this.dynamicStageListeners;for(let b=0;b<a.length;b++)a[b]();a.length=0,this.dynamicStagePromise.resolve()}getStagePromise(a){switch(a){case 3:return this.runtimeStagePromise.promise;case 4:return this.dynamicStagePromise.promise;default:throw Object.defineProperty(new g.InvariantError(`Invalid render stage: ${a}`),"__NEXT_ERROR_CODE",{value:"E881",enumerable:!1,configurable:!0})}}waitForStage(a){return this.getStagePromise(a)}delayUntilStage(a,b,c){var d,e,f;let g,h=(d=this.getStagePromise(a),e=b,f=c,g=new Promise((a,b)=>{d.then(a.bind(null,f),b)}),void 0!==e&&(g.displayName=e),g);return this.abortSignal&&h.catch(k),h}}function k(){}},73240,a=>{"use strict";let b=[{key:"WHATSAPP_TEXT",value:"whatsapp_text",label:"Message WhatsApp",shortLabel:"WhatsApp",description:"Messages texte via WhatsApp Business",icon:"message-circle",color:"green"},{key:"SMS",value:"sms",label:"SMS",shortLabel:"SMS",description:"Messages texte par SMS",icon:"message-square",color:"blue"},{key:"RINGLESS_VOICE",value:"ringless_voice",label:"Message Vocal",shortLabel:"Vocal",description:"Messages vocaux sans sonnerie",icon:"phone",color:"purple"}],c=Object.fromEntries(b.map(a=>[a.key,a.value]));b.map(a=>a.value);let d=[{key:"PENDING",value:"pending",label:"En attente",description:"Message en file d'attente",icon:"clock",color:"#eab308",class:"bg-yellow-900/30 text-yellow-400 border-yellow-900/50"},{key:"SENT",value:"sent",label:"Envoyé",description:"Message envoyé avec succès",icon:"send",color:"#3b82f6",class:"bg-blue-900/30 text-blue-400 border-blue-900/50"},{key:"DELIVERED",value:"delivered",label:"Délivré",description:"Message délivré au destinataire",icon:"check",color:"#22c55e",class:"bg-green-900/30 text-green-400 border-green-900/50"},{key:"FAILED",value:"failed",label:"Échoué",description:"Échec de l'envoi",icon:"x",color:"#ef4444",class:"bg-red-900/30 text-red-400 border-red-900/50"},{key:"READ",value:"read",label:"Lu",description:"Message lu par le destinataire",icon:"check-check",color:"#a855f7",class:"bg-purple-900/30 text-purple-400 border-purple-900/50"},{key:"REPLIED",value:"replied",label:"Répondu",description:"Destinataire a répondu",icon:"reply",color:"#10b981",class:"bg-emerald-900/30 text-emerald-400 border-emerald-900/50"}],e=Object.fromEntries(d.map(a=>[a.key,a.value])),f=d.map(a=>a.value);a.s(["EContactChannel",0,c,"EMessageStatus",0,e,"MESSAGE_STATUS_VALUES",0,f,"WHATSAPP_DAILY_LIMIT",0,1e3,"getMessageStatusConfig",0,a=>{let b=d.find(b=>b.value===a);if(!b)throw Error(`Invalid message status: ${a}`);return b}])},6495,a=>{"use strict";var b=a.i(81446);async function c(a,c){let d=a||await (0,b.createDrizzleSupabaseClient)(),e=await d.rls(async a=>a.query.accounts.findFirst({...c?.columnsToKeep&&{columns:c.columnsToKeep}}));if(!e)throw Error("account not found");return e}a.s(["getUserAccount",()=>c])},88158,(a,b,c)=>{"use strict";Object.defineProperty(c,"__esModule",{value:!0});var d={HTTPAccessErrorStatus:function(){return f},HTTP_ERROR_FALLBACK_ERROR_CODE:function(){return h},getAccessFallbackErrorTypeByStatus:function(){return k},getAccessFallbackHTTPStatus:function(){return j},isHTTPAccessFallbackError:function(){return i}};for(var e in d)Object.defineProperty(c,e,{enumerable:!0,get:d[e]});let f={NOT_FOUND:404,FORBIDDEN:403,UNAUTHORIZED:401},g=new Set(Object.values(f)),h="NEXT_HTTP_ERROR_FALLBACK";function i(a){if("object"!=typeof a||null===a||!("digest"in a)||"string"!=typeof a.digest)return!1;let[b,c]=a.digest.split(";");return b===h&&g.has(Number(c))}function j(a){return Number(a.digest.split(";")[1])}function k(a){switch(a){case 401:return"unauthorized";case 403:return"forbidden";case 404:return"not-found";default:return}}("function"==typeof c.default||"object"==typeof c.default&&null!==c.default)&&void 0===c.default.__esModule&&(Object.defineProperty(c.default,"__esModule",{value:!0}),Object.assign(c.default,c),b.exports=c.default)},1970,(a,b,c)=>{"use strict";Object.defineProperty(c,"__esModule",{value:!0}),Object.defineProperty(c,"RedirectStatusCode",{enumerable:!0,get:function(){return e}});var d,e=((d={})[d.SeeOther=303]="SeeOther",d[d.TemporaryRedirect=307]="TemporaryRedirect",d[d.PermanentRedirect=308]="PermanentRedirect",d);("function"==typeof c.default||"object"==typeof c.default&&null!==c.default)&&void 0===c.default.__esModule&&(Object.defineProperty(c.default,"__esModule",{value:!0}),Object.assign(c.default,c),b.exports=c.default)},23918,(a,b,c)=>{"use strict";Object.defineProperty(c,"__esModule",{value:!0});var d,e={REDIRECT_ERROR_CODE:function(){return h},RedirectType:function(){return i},isRedirectError:function(){return j}};for(var f in e)Object.defineProperty(c,f,{enumerable:!0,get:e[f]});let g=a.r(1970),h="NEXT_REDIRECT";var i=((d={}).push="push",d.replace="replace",d);function j(a){if("object"!=typeof a||null===a||!("digest"in a)||"string"!=typeof a.digest)return!1;let b=a.digest.split(";"),[c,d]=b,e=b.slice(2,-2).join(";"),f=Number(b.at(-2));return c===h&&("replace"===d||"push"===d)&&"string"==typeof e&&!isNaN(f)&&f in g.RedirectStatusCode}("function"==typeof c.default||"object"==typeof c.default&&null!==c.default)&&void 0===c.default.__esModule&&(Object.defineProperty(c.default,"__esModule",{value:!0}),Object.assign(c.default,c),b.exports=c.default)},71458,(a,b,c)=>{"use strict";Object.defineProperty(c,"__esModule",{value:!0}),Object.defineProperty(c,"isNextRouterError",{enumerable:!0,get:function(){return f}});let d=a.r(88158),e=a.r(23918);function f(a){return(0,e.isRedirectError)(a)||(0,d.isHTTPAccessFallbackError)(a)}("function"==typeof c.default||"object"==typeof c.default&&null!==c.default)&&void 0===c.default.__esModule&&(Object.defineProperty(c.default,"__esModule",{value:!0}),Object.assign(c.default,c),b.exports=c.default)},5522,(a,b,c)=>{"use strict";Object.defineProperty(c,"__esModule",{value:!0}),Object.defineProperty(c,"registerServerReference",{enumerable:!0,get:function(){return d.registerServerReference}});let d=a.r(82260)},51187,(a,b,c)=>{b.exports=a.x("next/dist/server/lib/incremental-cache/tags-manifest.external.js",()=>require("next/dist/server/lib/incremental-cache/tags-manifest.external.js"))},63224,a=>{"use strict";var b=a.i(81446);a.i(96875);var c=a.i(42810);async function d(){let a=await (0,b.createDrizzleSupabaseClient)(),[d,e,f]=await Promise.all([a.rls(a=>a.query.creditBalances.findFirst()),a.rls(a=>a.query.huntChannelCredits.findMany({with:{hunt:{columns:{id:!0,name:!0}}}})),a.rls(a=>a.query.creditTransactions.findMany({orderBy:a=>[(0,c.desc)(a.createdAt)],limit:50}))]);return{balance:d,huntAllocations:e.map(a=>({huntId:a.huntId,huntName:a.hunt.name,channel:a.channel,allocated:a.creditsAllocated,consumed:a.creditsConsumed,remaining:a.creditsAllocated-a.creditsConsumed})),transactions:f.map(a=>({id:a.id,type:a.type,channel:a.channel,amount:a.amount,balanceAfter:a.balanceAfter,createdAt:a.createdAt,metadata:a.metadata}))}}a.s(["getAccountCredits",()=>d])},34270,(a,b,c)=>{b.exports=a.x("next/dist/server/app-render/module-loading/track-module-loading.external.js",()=>require("next/dist/server/app-render/module-loading/track-module-loading.external.js"))},61980,(a,b,c)=>{"use strict";Object.defineProperty(c,"__esModule",{value:!0}),Object.defineProperty(c,"trackDynamicImport",{enumerable:!0,get:function(){return g}});let d=a.r(48638),e=a.r(94837),f=a.r(34270);function g(a){if(!(0,e.isThenable)(a))throw Object.defineProperty(new d.InvariantError("`trackDynamicImport` should always receive a promise. Something went wrong in the dynamic imports transform."),"__NEXT_ERROR_CODE",{value:"E677",enumerable:!1,configurable:!0});return(0,f.trackPendingImport)(a),a}},72705,(a,b,c)=>{"use strict";Object.defineProperty(c,"__esModule",{value:!0}),Object.defineProperty(c,"trackDynamicImport",{enumerable:!0,get:function(){return d.trackDynamicImport}});let d=a.r(61980)}];

//# sourceMappingURL=%5Broot-of-the-server%5D__4ad92a88._.js.map