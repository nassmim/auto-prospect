module.exports=[37320,a=>{"use strict";var b=a.i(81446);a.i(96875);var c=a.i(42810),d=a.i(4867),e=a.i(69070),f=a.i(20118);async function g(a){let e=await (0,b.createDrizzleSupabaseClient)();try{let b=await e.rls(async b=>b.query.leads.findFirst({where:(0,c.eq)(d.leads.id,a),with:{ad:{with:{brand:!0,fuel:!0,gearBox:!0,location:!0,type:!0,subtype:!0,vehicleState:!0,vehicleSeats:!0,drivingLicence:!0}},assignedTo:{columns:{id:!0,name:!0}},notes:{orderBy:(a,{desc:b})=>[b(a.createdAt)]},reminders:{orderBy:(a,{asc:b})=>[b(a.dueAt)]}}}));if(!b)throw Error("Lead not found");return b}catch(a){throw console.error("Error fetching lead details:",a),Error("Failed to fetch lead details")}}async function h(a){let e=await (0,b.createDrizzleSupabaseClient)();try{let b=await e.rls(b=>b.query.leads.findFirst({where:(0,c.eq)(d.leads.id,a),columns:{accountId:!0}}));if(!b)throw Error("Lead not found");return await e.rls(a=>a.query.teamMembers.findMany({where:(a,{eq:c})=>c(a.accountId,b.accountId)}))}catch{throw Error("Failed to fetch account members")}}async function i(a){let d=await (0,b.createDrizzleSupabaseClient)();try{return await d.rls(async b=>b.query.messages.findMany({where:(0,c.eq)(e.messages.leadId,a),with:{sentBy:{columns:{id:!0,name:!0}}},orderBy:(a,{desc:b})=>[b(a.sentAt)]}))}catch{throw Error("Failed to fetch messages")}}async function j(a){let c=await (0,b.createDrizzleSupabaseClient)();try{return await c.rls(async b=>b.query.leadActivities.findMany({where:(b,{eq:c})=>c(b.leadId,a),with:{lead:{with:{assignedTo:{columns:{id:!0,name:!0}}}}},orderBy:(a,{desc:b})=>[b(a.createdAt)]}))}catch{throw Error("Failed to fetch activities")}}async function k(a){let{huntId:e,dbClient:f,tx:g}=a||{},h=new Date;h.setHours(0,0,0,0);let i=[(0,c.gte)(d.leads.createdAt,h)];if(e&&i.push((0,c.eq)(d.leads.huntId,e)),g){let a=await g.select({count:c.sql`cast(count(*) as integer)`}).from(d.leads).where((0,c.and)(...i));return{todayLeadsCount:a[0]?.count??0}}let j=f||await (0,b.createDrizzleSupabaseClient)(),k=await j.rls(async a=>a.select({count:c.sql`cast(count(*) as integer)`}).from(d.leads).where((0,c.and)(...i)));return{todayLeadsCount:k[0]?.count??0}}async function l(a){let{huntId:e,dbClient:g,tx:h}=a||{},i=[(0,c.eq)(d.leads.stage,f.ELeadStage.CONTACTED)];if(e&&i.push((0,c.eq)(d.leads.huntId,e)),h){let a=await h.select({count:c.sql`cast(count(*) as integer)`}).from(d.leads).where((0,c.and)(...i));return{contactedLeadsCount:a[0]?.count??0}}let j=g||await (0,b.createDrizzleSupabaseClient)(),k=await j.rls(async a=>a.select({count:c.sql`cast(count(*) as integer)`}).from(d.leads).where((0,c.and)(...i)));return{contactedLeadsCount:k[0]?.count??0}}async function m(a){let e,{huntId:f,dbClient:g,tx:h}=a||{};if(f&&(e=(0,c.eq)(d.leads.huntId,f)),h){let a=await h.select({count:c.sql`cast(count(*) as integer)`}).from(d.leads).where(e);return{totalLeads:a[0]?.count??0}}let i=g||await (0,b.createDrizzleSupabaseClient)(),j=await i.rls(async a=>a.select({count:c.sql`cast(count(*) as integer)`}).from(d.leads).where(e));return{totalLeads:j[0]?.count??0}}async function n(){let a=await (0,b.createDrizzleSupabaseClient)();return await a.rls(async a=>(await a.query.leads.findMany({orderBy:(a,{asc:b})=>[b(a.stage),b(a.position)],with:{ad:{columns:{id:!0,title:!0,price:!0,picture:!0,phoneNumber:!0,isWhatsappPhone:!0},with:{location:{columns:{name:!0}}}}}})).map(a=>({id:a.id,stage:a.stage,position:a.position,ad:{title:a.ad.title,price:a.ad.price,picture:a.ad.picture,phoneNumber:a.ad.phoneNumber,isWhatsappPhone:a.ad.isWhatsappPhone,zipcode:{name:a.ad.location.name}}})))}a.s(["getContactedLeads",()=>l,"getLeadActivities",()=>j,"getLeadAssociatedTeamMembers",()=>h,"getLeadDetails",()=>g,"getLeadMessages",()=>i,"getPipelineLeads",()=>n,"getTodayNewLeads",()=>k,"getTotalLeads",()=>m])},59760,a=>{"use strict";a.i(5327);var b=a.i(25822),c=a.i(21732);let d=process.env.WORKER_API_URL,e=process.env.WORKER_API_SECRET,f=async(a,c)=>{if(!d||!e)return{success:!1,error:b.EGeneralErrorCode.UNKNOWN_ERROR};try{let f=await fetch(`${d}${a}`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify(c)}),g=await f.json();if(!f.ok)return{success:!1,error:g.error||b.EGeneralErrorCode.UNKNOWN_ERROR};return g}catch{return{success:!1,error:b.EGeneralErrorCode.UNKNOWN_ERROR}}};a.s(["sendSms",0,a=>f(c.WORKER_ROUTES.PHONE_SMS,a),"sendWhatsAppText",0,a=>f(c.WORKER_ROUTES.WHATSAPP_TEXT,a)])},72635,a=>{"use strict";var b=a.i(5522),c=a.i(52616),d=a.i(81446),e=a.i(23030),f=a.i(59760),g=a.i(6495),h=a.i(6347);a.i(5327);var i=a.i(81966);a.i(31460);var j=a.i(44594),k=a.i(33258);a.i(96875);var l=a.i(27692),m=a.i(42810),n=a.i(69070),o=a.i(25822),p=a.i(73240),q=a.i(675);async function r(a,b,f){let h=b.safeParse(a);if(!h.success)throw Error((0,e.formatZodError)(h.error));let i=h.data,j=await (0,d.createDrizzleSupabaseClient)();try{let a=(await (0,g.getUserAccount)(j,{columnsToKeep:{id:!0}})).id,b="channel"in i?i.channel:f;i.isDefault&&await j.rls(c=>c.update(n.messageTemplates).set({isDefault:!1}).where((0,m.and)((0,m.eq)(n.messageTemplates.accountId,a),(0,m.eq)(n.messageTemplates.channel,b))));let d={accountId:a,name:i.name,channel:i.channel,isDefault:i.isDefault||!1,audioUrl:"",audioDuration:0,content:""};d=f===p.EContactChannel.RINGLESS_VOICE?{...d,audioUrl:i.audioUrl,audioDuration:i.audioDuration}:{...d,content:i.content};let[e]=await j.rls(async a=>a.insert(n.messageTemplates).values(d).returning());return(0,q.updateTag)(c.CACHE_TAGS.templatesByAccount(a)),{success:!0,template:e}}catch{throw Error("Failed to create template")}}async function s(a){return r(a,j.textTemplateSchema,p.EContactChannel.SMS)}async function t(a){return r(a,j.voiceTemplateSchema,p.EContactChannel.RINGLESS_VOICE)}async function u(a){let b=await (0,d.createDrizzleSupabaseClient)();try{return await b.rls(async b=>{await b.delete(n.messageTemplates).where((0,m.eq)(n.messageTemplates.id,a))}),await (0,h.updateAccountTemplatesCache)(b),{success:!0}}catch(a){throw console.error("Error deleting template:",a),Error("Failed to delete template")}}async function v(a,b){let c=await (0,d.createDrizzleSupabaseClient)();try{let d={updatedAt:new Date};if(void 0!==b.name&&(d.name=b.name.trim()),void 0!==b.content&&(d.content=b.content.trim()),void 0!==b.isDefault&&(d.isDefault=b.isDefault,b.isDefault)){let b=await c.rls(async b=>b.query.messageTemplates.findFirst({where:(0,m.eq)(n.messageTemplates.id,a)}));b&&await c.rls(async a=>{let c=[(a,{eq:c,and:d})=>d(c(a.accountId,b.accountId),c(a.channel,b.channel))];b.channel&&c.push((a,{eq:c})=>c(a.channel,b.channel)),await a.update(n.messageTemplates).set({isDefault:!1}).where((0,m.and)(...c.map(a=>a(n.messageTemplates,{eq:m.eq,and:m.and}))))})}return await c.rls(async b=>{await b.update(n.messageTemplates).set(d).where((0,m.eq)(n.messageTemplates.id,a))}),await (0,h.updateAccountTemplatesCache)(c),{success:!0}}catch(a){throw console.error("Error updating template:",a),Error("Failed to update template")}}async function w(a){return(0,h.getDefaultWhatsAppTemplate)(a)}async function x(a,b,c){return(0,h.logWhatsAppMessage)(a,b,c)}async function y(a){let b=k.sendSmsSchema.safeParse(a);if(!b.success)return{success:!1,errorCode:o.EGeneralErrorCode.VALIDATION_FAILED};let{to:c,message:e}=b.data;try{let a=await (0,d.createDrizzleSupabaseClient)();if(!(await (0,g.getUserAccount)(a,{columnsToKeep:{smsApiKey:!0}})).smsApiKey)return{success:!1,errorCode:o.ESmsErrorCode.API_KEY_REQUIRED};let b=await (0,f.sendSms)({recipientPhone:c,message:e});if(!b.success)return{success:!1,errorCode:b.error};return{success:!0,data:{jobId:b.jobId}}}catch{return{success:!1,errorCode:o.ESmsErrorCode.MESSAGE_SEND_FAILED}}}async function z(a){let b=k.saveSmsApiKeySchema.safeParse(a);if(!b.success)return{success:!1,errorCode:o.EGeneralErrorCode.VALIDATION_FAILED};let{apiKey:c}=b.data;try{let a=await (0,d.createDrizzleSupabaseClient)(),b=await (0,g.getUserAccount)(a,{columnsToKeep:{id:!0,smsApiKey:!0}}),e=process.env.SMS_API_KEY_ENCRYPTION_KEY;if(!e)return{success:!1,errorCode:o.ESmsErrorCode.ENCRYPTION_KEY_MISSING};let f=(0,i.encryptCredentials)(c,e),h=await a.rls(a=>a.update(l.accounts).set({smsApiKey:f}).where((0,m.eq)(l.accounts.id,b.id)).returning({id:l.accounts.id}));if(!h||0===h.length)return{success:!1,errorCode:o.ESmsErrorCode.ACCOUNT_NOT_FOUND};return{success:!0}}catch{return{success:!1,errorCode:o.ESmsErrorCode.API_KEY_SAVE_FAILED}}}(0,a.i(14392).ensureServerEntryExports)([s,t,u,v,w,x,y,z]),(0,b.registerServerReference)(s,"4021a21e2ebc3b11b9eb361dc13b8c8d3a462ac830",null),(0,b.registerServerReference)(t,"4011379d0dcc2d6611e72de9b36fb3e2cb4cf29d76",null),(0,b.registerServerReference)(u,"40824ee978cb2b8fb0e4e394972f3a67fb09d6ab7a",null),(0,b.registerServerReference)(v,"60438bedd4b8a6eed80341a95b989183dd5e9fff6f",null),(0,b.registerServerReference)(w,"401540e838a62e09eb1eeaba6e998d062d354b5304",null),(0,b.registerServerReference)(x,"7013b2cfceb896ab0561b14d5adfd1fb89f374894b",null),(0,b.registerServerReference)(y,"40711bdcd157ee4f0bb00bd56280c29c32af8f3466",null),(0,b.registerServerReference)(z,"402961b2028c15cda53f446734899e6650751a28ec",null),a.s(["createTextTemplate",()=>s,"createVoiceTemplate",()=>t,"deleteTemplate",()=>u,"getDefaultWhatsAppTemplate",()=>w,"logWhatsAppMessage",()=>x,"saveSmsApiKeyAction",()=>z,"sendSmsAction",()=>y],72635)},5443,a=>{"use strict";a.i(5522);a.i(67304),a.i(81446),a.i(23030),a.i(37320);a.i(31460);a.i(21754);a.i(96875);a.i(42810),a.i(4867),a.i(675);let b=Error("Cannot find module '../../../../packages/db/src/supabase/server'");throw b.code="MODULE_NOT_FOUND",b},81381,a=>{a.v(a=>Promise.resolve().then(()=>a(675)))},44426,a=>{a.v(a=>Promise.resolve().then(()=>a(52616)))}];

//# sourceMappingURL=Projets_auto-prospect-worktrees_config_mono-repo_477568e6._.js.map