{"version":3,"sources":["../../../../../../../../../../Projets/auto-prospect-worktrees/config/mono-repo/node_modules/.pnpm/next%4016.1.1_%40babel%2Bcore%407.28.6_%40opentelemetry%2Bapi%401.9.0_react-dom%4019.2.3_react%4019.2.3__react%4019.2.3/node_modules/next/src/build/webpack/loaders/next-flight-loader/server-reference.ts","../../../../../../../../../../Projets/auto-prospect-worktrees/config/mono-repo/node_modules/.pnpm/next%4016.1.1_%40babel%2Bcore%407.28.6_%40opentelemetry%2Bapi%401.9.0_react-dom%4019.2.3_react%4019.2.3__react%4019.2.3/node_modules/next/src/build/webpack/loaders/next-flight-loader/action-validate.ts","../../../../../../../../../../Projets/auto-prospect-worktrees/config/mono-repo/apps/web/src/services/credit.service.ts","../../../../../../../../../../Projets/auto-prospect-worktrees/config/mono-repo/apps/web/src/actions/credit.actions.ts"],"sourcesContent":["/* eslint-disable import/no-extraneous-dependencies */\nexport { registerServerReference } from 'react-server-dom-webpack/server'\n","// This function ensures that all the exported values are valid server actions,\n// during the runtime. By definition all actions are required to be async\n// functions, but here we can only check that they are functions.\nexport function ensureServerEntryExports(actions: any[]) {\n  for (let i = 0; i < actions.length; i++) {\n    const action = actions[i]\n    if (typeof action !== 'function') {\n      throw new Error(\n        `A \"use server\" file can only export async functions, found ${typeof action}.\\nRead more: https://nextjs.org/docs/messages/invalid-use-server-value`\n      )\n    }\n  }\n}\n","import { createDrizzleSupabaseClient } from \"@/lib/db\";\nimport { desc, TCreditTransaction, TDBQuery } from \"@auto-prospect/db\";\nimport { TContactChannel } from \"@auto-prospect/shared/src/config/message.config\";\nimport { type TransactionType } from \"@auto-prospect/shared/src/config/payment.config\";\n\nexport type TConsumeCreditsParams = {\n  huntId: string;\n  channel: TContactChannel;\n  messageId?: string;\n  recipient?: string;\n};\n\nexport type TConsumeCreditsResult =\n  | { success: true; transaction: TCreditTransaction }\n  | { success: false; error: string };\n\nexport type TSubscription =\n  | void\n  | {\n      active: boolean;\n      id: string;\n      accountId: string | null;\n      updatedAt: string;\n      createdAt: string;\n      billingProvider: \"stripe\" | \"lemon-squeezy\" | \"paddle\";\n      currency: string;\n      billingCustomerId: number;\n      status:\n        | \"active\"\n        | \"trialing\"\n        | \"past_due\"\n        | \"canceled\"\n        | \"unpaid\"\n        | \"incomplete\"\n        | \"incomplete_expired\"\n        | \"paused\";\n      cancelAtPeriodEnd: boolean;\n      periodStartsAt: string;\n      periodEndsAt: string;\n      trialStartsAt: string | null;\n      trialEndsAt: string | null;\n    }\n  | undefined;\n\n/**\n * Gets all channel credits for a hunt\n */\nexport async function getHuntChannelCredits(huntId: string) {\n  // call the endpoint\n}\n\n/**\n * Gets complete credit data for the authenticated user's account\n * Used by the credits page to display balances, allocations, and transaction history\n */\nexport async function getAccountCredits() {\n  const dbClient = await createDrizzleSupabaseClient();\n\n  // Fetch credit balance, hunt allocations, and transaction history in parallel\n  const [balance, huntAllocations, transactions] = await Promise.all([\n    // Get account credit balance\n    dbClient.rls((tx: TDBQuery) => tx.query.creditBalances.findFirst()),\n\n    // Get hunt channel credit allocations with hunt names\n    dbClient.rls((tx: TDBQuery) =>\n      tx.query.huntChannelCredits.findMany({\n        with: {\n          hunt: {\n            columns: {\n              id: true,\n              name: true,\n            },\n          },\n        },\n      }),\n    ),\n\n    // Get recent credit transactions (last 50)\n    dbClient.rls((tx: TDBQuery) =>\n      tx.query.creditTransactions.findMany({\n        orderBy: (table) => [desc(table.createdAt)],\n        limit: 50,\n      }),\n    ),\n  ]);\n\n  return {\n    balance,\n    huntAllocations: huntAllocations.map((allocation) => ({\n      huntId: allocation.huntId,\n      huntName: allocation.hunt.name,\n      channel: allocation.channel as TContactChannel,\n      allocated: allocation.creditsAllocated,\n      consumed: allocation.creditsConsumed,\n      remaining: allocation.creditsAllocated - allocation.creditsConsumed,\n    })),\n    transactions: transactions.map((tx) => ({\n      id: tx.id,\n      type: tx.type as TransactionType,\n      channel: tx.channel as TContactChannel,\n      amount: tx.amount,\n      balanceAfter: tx.balanceAfter,\n      createdAt: tx.createdAt,\n      metadata: tx.metadata,\n    })),\n  };\n}\n","\"use server\";\n\nimport { getAccountCredits } from \"@/services/credit.service\";\n\n/**\n * Fetches complete credit data for the authenticated user's account\n * Server action wrapper for SWR client-side fetching\n */\nexport async function fetchAccountCredits() {\n  return getAccountCredits();\n}\n"],"names":["registerServerReference","ensureServerEntryExports","actions","i","length","action","Error"],"mappings":"4CAAoD,OAAA,cAAA,CAAA,EAAA,aAAA,oCAC3CA,0BAAAA,qCAAAA,EAAAA,uBAAuB,YAAQ,CAAA,CAAA,IAAA,iCCEjC,SAASC,EAAyBC,CAAc,EACrD,IAAK,IAAIC,EAAI,EAAGA,EAAID,EAAQE,MAAM,CAAED,IAAK,CACvC,IAAME,EAASH,CAAO,CAACC,EAAE,CACzB,GAAsB,YAAlB,AAA8B,OAAvBE,EACT,MAAM,OAAA,cAEL,CAFK,AAAIC,MACR,CAAC,2DAA2D,EAAE,OAAOD,EAAO;AAAA,oEAAuE,CAAC,EADhJ,oBAAA,OAAA,mBAAA,gBAAA,CAEN,EAEJ,CACF,0EATgBJ,2BAAAA,qCAAAA,6BCHhB,IAAA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,CAAA,CAAA,OAAA,IAAA,EAAA,EAAA,CAAA,CAAA,OAsDO,eAAe,IACpB,IAAM,EAAW,MAAM,CAAA,EAAA,EAAA,2BAAA,AAA2B,IAG5C,CAAC,EAAS,EAAiB,EAAa,CAAG,MAAM,QAAQ,GAAG,CAAC,CAEjE,EAAS,GAAG,CAAC,AAAC,GAAiB,EAAG,KAAK,CAAC,cAAc,CAAC,SAAS,IAGhE,EAAS,GAAG,CAAC,AAAC,GACZ,EAAG,KAAK,CAAC,kBAAkB,CAAC,QAAQ,CAAC,CACnC,KAAM,CACJ,KAAM,CACJ,QAAS,CACP,IAAI,EACJ,MAAM,CACR,CACF,CACF,CACF,IAIF,EAAS,GAAG,CAAC,AAAC,GACZ,EAAG,KAAK,CAAC,kBAAkB,CAAC,QAAQ,CAAC,CACnC,QAAU,AAAD,GAAW,CAAC,CAAA,EAAA,EAAA,IAAA,AAAI,EAAC,EAAM,SAAS,EAAE,CAC3C,MAAO,EACT,IAEH,EAED,MAAO,SACL,EACA,gBAAiB,EAAgB,GAAG,CAAC,AAAC,IAAgB,CACpD,OAAQ,CAD2C,CAChC,MAAM,CACzB,SAAU,EAAW,IAAI,CAAC,IAAI,CAC9B,QAAS,EAAW,OAAO,CAC3B,UAAW,EAAW,gBAAgB,CACtC,SAAU,EAAW,eAAe,CACpC,UAAW,EAAW,gBAAgB,CAAG,EAAW,eAAe,CACrE,CAAC,EACD,aAAc,EAAa,GAAG,CAAC,AAAC,IAAQ,CAAD,AACrC,GAAI,EAAG,EAAE,CACT,KAAM,EAAG,IAAI,CACb,QAAS,EAAG,OAAO,CACnB,OAAQ,EAAG,MAAM,CACjB,aAAc,EAAG,YAAY,CAC7B,UAAW,EAAG,SAAS,CACvB,SAAU,EAAG,QAAQ,CACvB,CAAC,CACH,CACF,0ECxGA,EAAA,EAAA,CAAA,CAAA,OAMO,eAAe,IACpB,MAAO,CAAA,EAAA,EAAA,iBAAA,AAAiB,GAC1B,0CAFsB,IAAA,CAAA,EAAA,EAAA,uBAAA,EAAA,EAAA,6CAAA","ignoreList":[0,1]}