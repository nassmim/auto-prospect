module.exports=[37320,a=>{"use strict";var b=a.i(81446);a.i(96875);var c=a.i(42810),d=a.i(4867),e=a.i(69070),f=a.i(20118);async function g(a){let e=await (0,b.createDrizzleSupabaseClient)();try{let b=await e.rls(async b=>b.query.leads.findFirst({where:(0,c.eq)(d.leads.id,a),with:{ad:{with:{brand:!0,fuel:!0,gearBox:!0,location:!0,type:!0,subtype:!0,vehicleState:!0,vehicleSeats:!0,drivingLicence:!0}},assignedTo:{columns:{id:!0,name:!0}},notes:{orderBy:(a,{desc:b})=>[b(a.createdAt)]},reminders:{orderBy:(a,{asc:b})=>[b(a.dueAt)]}}}));if(!b)throw Error("Lead not found");return b}catch(a){throw console.error("Error fetching lead details:",a),Error("Failed to fetch lead details")}}async function h(a){let e=await (0,b.createDrizzleSupabaseClient)();try{let b=await e.rls(b=>b.query.leads.findFirst({where:(0,c.eq)(d.leads.id,a),columns:{accountId:!0}}));if(!b)throw Error("Lead not found");return await e.rls(a=>a.query.teamMembers.findMany({where:(a,{eq:c})=>c(a.accountId,b.accountId)}))}catch{throw Error("Failed to fetch account members")}}async function i(a){let d=await (0,b.createDrizzleSupabaseClient)();try{return await d.rls(async b=>b.query.messages.findMany({where:(0,c.eq)(e.messages.leadId,a),with:{sentBy:{columns:{id:!0,name:!0}}},orderBy:(a,{desc:b})=>[b(a.sentAt)]}))}catch{throw Error("Failed to fetch messages")}}async function j(a){let c=await (0,b.createDrizzleSupabaseClient)();try{return await c.rls(async b=>b.query.leadActivities.findMany({where:(b,{eq:c})=>c(b.leadId,a),with:{lead:{with:{assignedTo:{columns:{id:!0,name:!0}}}}},orderBy:(a,{desc:b})=>[b(a.createdAt)]}))}catch{throw Error("Failed to fetch activities")}}async function k(a){let{huntId:e,dbClient:f,tx:g}=a||{},h=new Date;h.setHours(0,0,0,0);let i=[(0,c.gte)(d.leads.createdAt,h)];if(e&&i.push((0,c.eq)(d.leads.huntId,e)),g){let a=await g.select({count:c.sql`cast(count(*) as integer)`}).from(d.leads).where((0,c.and)(...i));return{todayLeadsCount:a[0]?.count??0}}let j=f||await (0,b.createDrizzleSupabaseClient)(),k=await j.rls(async a=>a.select({count:c.sql`cast(count(*) as integer)`}).from(d.leads).where((0,c.and)(...i)));return{todayLeadsCount:k[0]?.count??0}}async function l(a){let{huntId:e,dbClient:g,tx:h}=a||{},i=[(0,c.eq)(d.leads.stage,f.ELeadStage.CONTACTED)];if(e&&i.push((0,c.eq)(d.leads.huntId,e)),h){let a=await h.select({count:c.sql`cast(count(*) as integer)`}).from(d.leads).where((0,c.and)(...i));return{contactedLeadsCount:a[0]?.count??0}}let j=g||await (0,b.createDrizzleSupabaseClient)(),k=await j.rls(async a=>a.select({count:c.sql`cast(count(*) as integer)`}).from(d.leads).where((0,c.and)(...i)));return{contactedLeadsCount:k[0]?.count??0}}async function m(a){let e,{huntId:f,dbClient:g,tx:h}=a||{};if(f&&(e=(0,c.eq)(d.leads.huntId,f)),h){let a=await h.select({count:c.sql`cast(count(*) as integer)`}).from(d.leads).where(e);return{totalLeads:a[0]?.count??0}}let i=g||await (0,b.createDrizzleSupabaseClient)(),j=await i.rls(async a=>a.select({count:c.sql`cast(count(*) as integer)`}).from(d.leads).where(e));return{totalLeads:j[0]?.count??0}}async function n(){let a=await (0,b.createDrizzleSupabaseClient)();return await a.rls(async a=>(await a.query.leads.findMany({orderBy:(a,{asc:b})=>[b(a.stage),b(a.position)],with:{ad:{columns:{id:!0,title:!0,price:!0,picture:!0,phoneNumber:!0,isWhatsappPhone:!0},with:{location:{columns:{name:!0}}}}}})).map(a=>({id:a.id,stage:a.stage,position:a.position,ad:{title:a.ad.title,price:a.ad.price,picture:a.ad.picture,phoneNumber:a.ad.phoneNumber,isWhatsappPhone:a.ad.isWhatsappPhone,zipcode:{name:a.ad.location.name}}})))}a.s(["getContactedLeads",()=>l,"getLeadActivities",()=>j,"getLeadAssociatedTeamMembers",()=>h,"getLeadDetails",()=>g,"getLeadMessages",()=>i,"getPipelineLeads",()=>n,"getTodayNewLeads",()=>k,"getTotalLeads",()=>m])},12789,a=>{"use strict";var b=a.i(5522),c=a.i(20840),d=a.i(26442),e=a.i(52616),f=a.i(81446),g=a.i(6495),h=a.i(37320);a.i(5327);var i=a.i(66811),j=a.i(42025),k=a.i(675);async function l(){let a=await (0,f.createDrizzleSupabaseClient)();return o((await (0,g.getUserAccount)(a,{columnsToKeep:{id:!0}})).id,a)}let m=async function(a,b){(0,k.cacheTag)(e.CACHE_TAGS.huntsByAccount(a));let c=b||await (0,f.createDrizzleSupabaseClient)();return await c.rls(async a=>a.query.hunts.findMany({orderBy:(a,{desc:b})=>[b(a.createdAt)],with:i.HUNT_WITH_RELATIONS}))};var n=(0,d.cache)(function(){return(0,c.cache)("default","e0c6d22713dddd2f666ea2bc6c4707dc5bd51b4e50",0,m,arguments)});(0,b.registerServerReference)(n,"e0c6d22713dddd2f666ea2bc6c4707dc5bd51b4e50",null),Object.defineProperty(n,"name",{value:"getCachedAccountHuntsConfig"});var o=n;async function p(a){let b=await (0,f.createDrizzleSupabaseClient)(),c=await b.rls(async b=>b.query.huntChannelCredits.findMany({where:(b,{inArray:c})=>c(b.huntId,a)})),d=new Map;for(let a of c)d.has(a.huntId)||d.set(a.huntId,[]),d.get(a.huntId).push(a);return d}async function q(){let a=await l();if(0===a.length)return[];let b=a.map(({id:a})=>a),c=await p(b);return a.map(a=>({...a,channelCredits:c.get(a.id)||[]}))}async function r(a){let b=await (0,f.createDrizzleSupabaseClient)();return u(a,(await (0,g.getUserAccount)(b,{columnsToKeep:{id:!0}})).id,b)}let s=async function(a,b,c){(0,k.cacheTag)(e.CACHE_TAGS.hunt(a),e.CACHE_TAGS.huntsByAccount(b));let d=c||await (0,f.createDrizzleSupabaseClient)(),g=await d.rls(async b=>b.query.hunts.findFirst({where:(b,{eq:c})=>c(b.id,a),with:i.HUNT_WITH_RELATIONS}));if(!g)throw Error("hunt not found");return g};var t=(0,d.cache)(function(){return(0,c.cache)("default","f0165f65ac6657ab99c1343b90c7d1753d9ed0dfd5",0,s,arguments)});(0,b.registerServerReference)(t,"f0165f65ac6657ab99c1343b90c7d1753d9ed0dfd5",null),Object.defineProperty(t,"name",{value:"getCachedHuntConfigById"});var u=t;async function v(a){let b=await r(a),c=await (0,f.createDrizzleSupabaseClient)(),d=await c.rls(async b=>b.query.huntChannelCredits.findMany({where:(b,{eq:c})=>c(b.huntId,a)}));return{...b,channelCredits:d}}async function w(){let a=await (0,f.createDrizzleSupabaseClient)();return await a.rls(async a=>{let b=await a.query.hunts.findMany({where:(a,{eq:b})=>b(a.status,j.EHuntStatus.ACTIVE),orderBy:(a,{desc:b})=>[b(a.lastScanAt),b(a.createdAt)],limit:10});return await Promise.all(b.map(async b=>{let[{totalLeads:c},{contactedLeadsCount:d}]=await Promise.all([(0,h.getTotalLeads)({huntId:b.id,tx:a}),(0,h.getContactedLeads)({huntId:b.id,tx:a})]);return{id:b.id,name:b.name,status:b.status,leadCount:c,contactedCount:d,lastScanAt:b.lastScanAt,createdAt:b.createdAt}}))})}let x=async(a,b,c)=>{let d=c;d||(d=(await (0,g.getUserAccount)(a,{columnsToKeep:{id:!0}})).id),(0,k.updateTag)(e.CACHE_TAGS.huntsByAccount(d)),b&&(0,k.updateTag)(e.CACHE_TAGS.hunt(b))};a.s(["$$RSC_SERVER_CACHE_0",()=>n,"$$RSC_SERVER_CACHE_1",()=>t,"getAccountHunts",()=>q,"getActiveHunts",()=>w,"getHuntById",()=>v,"updateAccountHuntsCache",0,x])},75929,a=>{"use strict";var b=a.i(5522),c=a.i(52616),d=a.i(81446),e=a.i(18885),f=a.i(23030),g=a.i(6495),h=a.i(12789);a.i(31460);var i=a.i(5707);a.i(96875);var j=a.i(70530),k=a.i(42810),l=a.i(77554),m=a.i(42025),n=a.i(73240),o=a.i(675);async function p(){return(0,h.getAccountHunts)()}async function q(a){return(0,h.getHuntById)(a)}async function r(a){let b=i.createHuntSchema.safeParse(a);if(!b.success)throw Error((0,f.formatZodError)(b.error));let e=b.data,h=await (0,d.createDrizzleSupabaseClient)(),k=await (0,g.getUserAccount)(h,{columnsToKeep:{id:!0}}),p=await h.rls(async a=>{let[b]=await a.insert(j.hunts).values({accountId:k.id,name:e.name,locationId:e.locationId,typeId:e.adTypeId,status:m.EHuntStatus.ACTIVE,radiusInKm:e.radiusInKm,dailyPacingLimit:e.dailyPacingLimit,autoRefresh:e.autoRefresh,outreachSettings:e.outreachSettings,templateIds:e.templateIds,priceMin:e.priceMin,priceMax:e.priceMax,mileageMin:e.mileageMin,mileageMax:e.mileageMax,modelYearMin:e.modelYearMin,modelYearMax:e.modelYearMax,hasBeenReposted:e.hasBeenReposted,priceHasDropped:e.priceHasDropped,isUrgent:e.isUrgent,hasBeenBoosted:e.hasBeenBoosted,isLowPrice:e.isLowPrice}).returning();e.brandIds?.length&&await a.insert(j.brandsHunts).values(e.brandIds.map(a=>({huntId:b.id,brandId:a}))),e.subTypeIds?.length&&await a.insert(j.subTypesHunts).values(e.subTypeIds.map(a=>({huntId:b.id,subTypeId:a})));let c=[];return e.channelCredits?.sms&&e.channelCredits.sms>0&&c.push({huntId:b.id,channel:n.EContactChannel.SMS,creditsAllocated:e.channelCredits.sms,creditsConsumed:0}),e.outreachSettings?.whatsapp&&c.push({huntId:b.id,channel:n.EContactChannel.WHATSAPP_TEXT,creditsAllocated:n.WHATSAPP_DAILY_LIMIT,creditsConsumed:0}),e.channelCredits?.ringlessVoice&&e.channelCredits.ringlessVoice>0&&c.push({huntId:b.id,channel:n.EContactChannel.RINGLESS_VOICE,creditsAllocated:e.channelCredits.ringlessVoice,creditsConsumed:0}),c.length>0&&await a.insert(l.huntChannelCredits).values(c),b});return(0,o.updateTag)(c.CACHE_TAGS.huntsByAccount(k.id)),p}async function s(a,b){let c=await (0,d.createDrizzleSupabaseClient)(),[e]=await c.rls(async c=>c.update(j.hunts).set({status:b}).where((0,k.eq)(j.hunts.id,a)).returning());return await (0,h.updateAccountHuntsCache)(c,a),e}async function t(a,b){let c=i.updateHuntSchema.safeParse(b);if(!c.success)throw Error((0,f.formatZodError)(c.error));let e=c.data,g=await (0,d.createDrizzleSupabaseClient)(),[l]=await g.rls(async b=>await b.update(j.hunts).set(e).where((0,k.eq)(j.hunts.id,a)).returning());return await (0,h.updateAccountHuntsCache)(g,a),l}async function u(a,b){let c=await (0,e.createClient)(),{data:f}=await c.auth.getUser();if(!f.user)throw Error("Non authentifiÃ©");let g=await (0,d.createDrizzleSupabaseClient)();return await g.rls(async c=>{if(void 0!==b.sms&&b.sms>0){let d=await c.query.huntChannelCredits.findFirst({where:(b,{and:c,eq:d})=>c(d(b.huntId,a),d(b.channel,n.EContactChannel.SMS))});d?await c.update(l.huntChannelCredits).set({creditsAllocated:b.sms}).where((0,k.eq)(l.huntChannelCredits.id,d.id)):await c.insert(l.huntChannelCredits).values({huntId:a,channel:n.EContactChannel.SMS,creditsAllocated:b.sms,creditsConsumed:0})}if(void 0!==b.whatsapp){let b=n.WHATSAPP_DAILY_LIMIT,d=await c.query.huntChannelCredits.findFirst({where:(b,{and:c,eq:d})=>c(d(b.huntId,a),d(b.channel,n.EContactChannel.WHATSAPP_TEXT))});d?await c.update(l.huntChannelCredits).set({creditsAllocated:b}).where((0,k.eq)(l.huntChannelCredits.id,d.id)):await c.insert(l.huntChannelCredits).values({huntId:a,channel:n.EContactChannel.WHATSAPP_TEXT,creditsAllocated:b,creditsConsumed:0})}if(void 0!==b.ringlessVoice&&b.ringlessVoice>0){let d=await c.query.huntChannelCredits.findFirst({where:(b,{and:c,eq:d})=>c(d(b.huntId,a),d(b.channel,n.EContactChannel.RINGLESS_VOICE))});d?await c.update(l.huntChannelCredits).set({creditsAllocated:b.ringlessVoice}).where((0,k.eq)(l.huntChannelCredits.id,d.id)):await c.insert(l.huntChannelCredits).values({huntId:a,channel:n.EContactChannel.RINGLESS_VOICE,creditsAllocated:b.ringlessVoice,creditsConsumed:0})}}),{success:!0}}async function v(a){let b=await (0,d.createDrizzleSupabaseClient)();return await b.rls(async b=>b.delete(j.hunts).where((0,k.eq)(j.hunts.id,a))),await (0,h.updateAccountHuntsCache)(b,a),{success:!0}}(0,a.i(14392).ensureServerEntryExports)([p,q,r,s,t,u,v]),(0,b.registerServerReference)(p,"0027807b1796263ca4dc942e4fd93593fc586b9d23",null),(0,b.registerServerReference)(q,"405271852011e7db309e02cc9ed2c47206fea1b596",null),(0,b.registerServerReference)(r,"40bc40327414d65c149623d29751f6236173c3d9aa",null),(0,b.registerServerReference)(s,"608712871730495949abd4adbd7ebfa5e62d9e0336",null),(0,b.registerServerReference)(t,"60611e6860255adc0799d2db64bb54465f1f907a39",null),(0,b.registerServerReference)(u,"601fbece35aa53f5544b431616a0a70f442e2638a5",null),(0,b.registerServerReference)(v,"40dd0979f98dc61a675f39899fdebf86ceddacad5e",null),a.s(["createHunt",()=>r,"deleteHunt",()=>v,"fetchAccountHunts",()=>p,"updateHunt",()=>t,"updateHuntStatus",()=>s])},52239,a=>{"use strict";var b=a.i(75929),c=a.i(12789),d=a.i(6347);a.s([],10823),a.i(10823),a.s(["40bc40327414d65c149623d29751f6236173c3d9aa",()=>b.createHunt,"60611e6860255adc0799d2db64bb54465f1f907a39",()=>b.updateHunt,"e0c6d22713dddd2f666ea2bc6c4707dc5bd51b4e50",()=>c.$$RSC_SERVER_CACHE_0,"e0d884f19ec9288fa94a30ca8841972647d88a166f",()=>d.$$RSC_SERVER_CACHE_0,"f0165f65ac6657ab99c1343b90c7d1753d9ed0dfd5",()=>c.$$RSC_SERVER_CACHE_1],52239)},81381,a=>{a.v(a=>Promise.resolve().then(()=>a(675)))},44426,a=>{a.v(a=>Promise.resolve().then(()=>a(52616)))}];

//# sourceMappingURL=Projets_auto-prospect-worktrees_config_mono-repo_1bd184b6._.js.map